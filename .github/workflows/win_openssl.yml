name: "Test OpenSSL Windows"
on: [push, pull_request]

jobs:
  win:
    runs-on: windows-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - uses: ilammy/msvc-dev-cmd@v1
      - name: Build
        run: |
          if (test-path build.paho) {
          rm build.paho -r -fo
          }
          mkdir build.paho
          cd build.paho
          echo "pwd $PWD"
          cmake -G "NMake Makefiles" -DPAHO_WITH_SSL=TRUE -DPAHO_BUILD_DOCUMENTATION=FALSE -DPAHO_BUILD_SAMPLES=TRUE -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=TRUE -DPAHO_BUILD_STATIC=FALSE -DPAHO_BUILD_SHARED=TRUE -DPAHO_HIGH_PERFORMANCE=TRUE ..
          nmake
      - name: Start test broker
        run: |
          python --version
          git clone https://github.com/eclipse/paho.mqtt.testing.git
          cd paho.mqtt.testing/interoperability
          Start-Process python -ArgumentList 'startbroker.py -c localhost_testing.conf'
      - name: Start test proxy
        run: |
          Start-Process python -ArgumentList 'test/mqttsas.py'
      - name: run tests
        run: |
          cd build.paho
          # ctest -C Debug -VV --timeout 600
          ctest -T test -VV
      - name: clean up
        run: |
          taskkill /IM python.exe /F
          sleep 3 # allow broker time to terminate and report
